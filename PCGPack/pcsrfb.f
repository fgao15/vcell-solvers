      SUBROUTINEPCSRFB(N,IJA,A,RHS,ISP,RSP,LINK,IPTR,IC,C,CP,
     *NBLCKB,NBLACK,IJAB,IBLKN,IBLKS,IBTRM,IRTBM,IBTRMC,ID2I,
     *D2I,NZRS,IJRS,RS,RSRHS,Y,IMN,ISCR,RSNADR,NSP1)
      IMPLICITDOUBLEPRECISION(A-H,O-Z)
      INTEGERN,IJA(*),ISP(*),LINK,IPTR,IC,C,CP,NBLCKB,NBLACK
     *,IJAB,IBLKN,IBLKS,IBTRM,IRTBM,IBTRMC,ID2I,D2I,NZRS,IJRS,
     *RS,RSRHS,Y,IMN,ISCR,RSNADR,NSP1
      DOUBLEPRECISIONA(*),RHS(*),RSP(*)
      INTEGERIERR,ITMAX,ITEST,KMAX,IFL,IPRE,PBLK,LUDONE,IBLK,
     *MNEED,ITS,RSDONE,NOVERF,RED1,RED2,IERR2,IFRMAT
      COMMON/PCCOM1/IERR,ITMAX,ITEST,KMAX,IFL,IPRE,PBLK,
     *LUDONE,IBLK,MNEED,ITS,RSDONE,NOVERF,RED1,RED2,IERR2,
     *IFRMAT
      SAVE/PCCOM1/
      INTEGERIPRE1,IPRE2,RATIO
      COMMON/PCCOM3/IPRE1,IPRE2,RATIO
      SAVE/PCCOM3/
      LOGICALLOWER,UPPER,FULL,HALF,SYMMAT
      COMMON/PCVERL/LOWER,UPPER,FULL,HALF,SYMMAT
      SAVE/PCVERL/
      INTEGERINADR,MAXBLK,ND2I,IJRSB,NZRSMX,NZRB,MARK,FIC,IRC,
     *AILAST,NZR,NZRSB,NZRBMX,NREDB,NSP,NADR,
     *IJABP,C1DI,NFREE
      INTEGERSPACEN,KIBLKN,KMXBLK,KNZRB,KNZRS,KNBLKB,KND2I,KNBLK,
     *SPHALF
      SPACEN(KIBLKN,KMXBLK,KNZRB,KNZRS,KNBLKB,KND2I,KNBLK,SPHALF)=
     *(6*KIBLKN+2+N+KNBLK+KNZRB+KNZRS-KNBLKB+SPHALF
     *+RATIO-1)/RATIO+KNBLK+KND2I+KNZRS+N+KMXBLK
      NADR=ISP(2)
      NFREE=ISP(1)
      NSP=NFREE+NADR-1
      INADR=(NADR-1)*RATIO+1
      IF(RSDONE.EQ.0)THEN
      NZR=IJA(N+1)-1
      LINK=INADR
      IF(HALF)THEN
      IF(NFREE*RATIO.LT.2*NZR)THEN
      MAXBLK=IBLK
      IF(IBLK.LT.1)THEN
      MAXBLK=2
      ENDIF
      IBLKN=(N+MAXBLK-1)/MAXBLK
      NBLACK=N/2
      NBLCKB=NBLACK/MAXBLK
      NZRB=NZR/(MAXBLK*MAXBLK)
      ND2I=NBLACK*MAXBLK+NBLACK
      NZRS=NZR
      SPHALF=2*NZR+NZRB
      MNEED=MNEED+SPACEN(IBLKN,MAXBLK,NZRB,NZRS,NBLCKB,
     *ND2I,NBLACK,SPHALF)
      IMN=MNEED
      ISCR=0
      MNEED=MNEED-NSP
      IERR=10
      RETURN
      ENDIF
      IPTR=LINK+NZR
      INADR=IPTR+NZR
      CALLPCICTR(N,IJA,ISP(IPTR),ISP(LINK))
      ELSE
      IPTR=INADR
      SPHALF=0
      ENDIF
      IBLKS=INADR
      IF(IBLKS+N.GT.NSP*RATIO)THEN
      MAXBLK=IBLK
      IF(IBLK.LT.1)THEN
      MAXBLK=2
      ENDIF
      IBLKN=(N+MAXBLK-1)/MAXBLK
      NBLACK=N/2
      NBLCKB=NBLACK/MAXBLK
      NZRB=NZR/(MAXBLK*MAXBLK)
      ND2I=NBLACK*MAXBLK+NBLACK
      NZRS=NZR
      MNEED=MNEED+SPACEN(IBLKN,MAXBLK,NZRB,NZRS,NBLCKB,ND2I
     *,NBLACK,SPHALF)
      IMN=MNEED
      ISCR=0
      MNEED=MNEED-NSP
      IERR=10
      RETURN
      ENDIF
      CALLPCIBLK(N,IBLK,IJA,IBLKN,MAXBLK,ISP(IBLKS))
      IRTBM=IBLKS+IBLKN
      IBTRM=IRTBM+N
      IBTRMC=IBTRM+IBLKN+1
      IC=IBTRMC+IBLKN+1
      C=IC+IBLKN
      IJAB=C+IBLKN
      AILAST=NSP*RATIO+1
      MARK=AILAST-IBLKN
      IF(IJAB+NZR.GT.MARK)THEN
      NBLACK=N/2
      NBLCKB=NBLACK/MAXBLK
      NZRB=NZR/(MAXBLK*MAXBLK)
      NZRS=NZR
      ND2I=NBLACK*MAXBLK+NBLACK
      MNEED=MNEED+SPACEN(IBLKN,MAXBLK,NZRB,NZRS,NBLCKB,ND2I
     *,NBLACK,SPHALF)
      IMN=MNEED
      ISCR=0
      MNEED=MNEED-NFREE
      IERR=10
      RETURN
      ENDIF
      CALLPCBTRC(N,IBLKN,IBLK,ISP(IBLKS),ISP(IBTRM),ISP(IRTBM))
      NZRBMX=MARK-IJAB
      CALLPCIJAB(N,IJA,IBLKN,NZRBMX,ISP(IBLKS),ISP(IRTBM),ISP(IJAB)
     *,ISP(MARK))
      IF(IERR.NE.0)THEN
      NBLACK=N/2
      NBLCKB=NBLACK/MAXBLK
      NZRB=NZRBMX
      NZRS=NZR
      ND2I=NBLACK*MAXBLK+NBLACK
      MNEED=MNEED+SPACEN(IBLKN,MAXBLK,NZRB,NZRS,NBLCKB,ND2I
     *,NBLACK,SPHALF)
      IMN=MNEED
      ISCR=0
      MNEED=MNEED-NFREE
      IERR=10
      RETURN
      ENDIF
      NZRB=ISP(IJAB+IBLKN)-1
      IF(HALF)THEN
      IJABP=IJAB+NZRB
      SPHALF=2*NZR+NZRB
      ELSE
      IJABP=IJAB
      SPHALF=0
      ENDIF
      CP=IJABP+NZRB
      INADR=CP+N
      NADR=(INADR-1)*RATIO+1
      IF(NADR.GT.NSP)THEN
      NBLACK=N/2
      NBLCKB=NBLACK/MAXBLK
      NZRS=NZR
      ND2I=NBLACK*MAXBLK+NBLACK
      MNEED=MNEED+SPACEN(IBLKN,MAXBLK,NZRB,NZRS,NBLCKB,ND2I
     *,NBLACK,SPHALF)
      IMN=MNEED
      ISCR=0
      MNEED=MNEED-NFREE
      IERR=10
      RETURN
      ENDIF
      CALLPCSROB(N,IBLKN,ISP(IBLKS),ISP(IBTRM),ISP(IJAB),ND2I,
     *NBLCKB,NBLACK,ISP(C),ISP(IC),ISP(IJABP),ISP(IBTRMC),ISP(
     *CP))
      NREDB=IBLKN-NBLCKB
      FIC=MARK-NBLCKB
      IJRSB=CP+NBLACK
      NZRSMX=FIC-IJRSB
      IF(NZRSMX.LT.0)THEN
      NZRS=NZR
      MNEED=MNEED+SPACEN(IBLKN,MAXBLK,NZRB,NZRS,NBLCKB,ND2I,
     *NBLACK,SPHALF)
      IMN=MNEED
      ISCR=0
      MNEED=MNEED-NSP
      IERR=10
      RETURN
      ENDIF
      IF(NBLCKB.NE.0)THEN
      IF(HALF)THEN
      CALLPCSRSB(IBLKN,NZRSMX,NBLCKB,ISP(C),ISP(IC),ISP(
     *IJAB),ISP(IJABP),NZRSB,IRC,ISP(IJRSB),ISP(MARK),ISP
     *(FIC))
      ELSE
      CALLPCSRZP(IBLKN,NZRSMX,NBLCKB,ISP(C),ISP(IC),ISP(
     *IJAB),NZRSB,IRC,ISP(IJRSB),ISP(MARK),ISP(FIC))
      ENDIF
      IF(IRC.NE.0)THEN
      NZRS=MAX((NZRSMX+IRC)*MAXBLK*MAXBLK,NZR)
      MNEED=MNEED+SPACEN(IBLKN,MAXBLK,NZRB,NZRS,NBLCKB,ND2I
     *,NBLACK,SPHALF)
      IMN=MNEED
      ISCR=0
      MNEED=MNEED-NSP
      IERR=10
      RETURN
      ENDIF
      ELSE
      NZRSB=0
      ENDIF
      CALLPCICPY(NZRSB,ISP(IJRSB),ISP(AILAST-NZRSB))
      IJRS=IJRSB
      IJRSB=AILAST-NZRSB
      NZRSMX=IJRSB-IJRS
      NBLACK=ISP(IBTRMC+NBLCKB)-1
      IRC=NZRSMX
      CALLPCIJUP(NBLACK,NBLCKB,ISP(IBTRMC),ISP(IJRSB),ISP(IJRS),IRC)
      IF(IRC.LT.0)THEN
      NZRS=MAX(NZRSMX-IRC,NZR)
      MNEED=MNEED+SPACEN(IBLKN,MAXBLK,NZRB,NZRS,NBLCKB,ND2I,
     *NBLACK,SPHALF)
      IMN=MNEED
      ISCR=0
      MNEED=MNEED-NSP
      IERR=10
      RETURN
      ENDIF
      NZRS=ISP(IJRS+NBLACK)-1
      ID2I=IJRS+NZRS
      NADR=(ID2I+NREDB+RATIO-1)/RATIO+1
      RSNADR=NADR
      RSRHS=NSP+1-NBLACK
      D2I=RSRHS-ND2I
      RS=D2I-NZRS
      Y=RS-N
      NSP1=Y-NADR
      C1DI=Y-MAXBLK
      IF(NSP1.LT.MAXBLK)THEN
      MNEED=MNEED+SPACEN(IBLKN,MAXBLK,NZRB,NZRS,NBLCKB,ND2I,
     *NBLACK,SPHALF)
      IMN=MNEED
      ISCR=0
      MNEED=MNEED-NSP
      IERR=10
      RETURN
      ENDIF
      ENDIF
      CALLPCSD2F(N,IBLKN,ISP(IBLKS),ISP(IBTRM),ISP(IRTBM),ISP(
     *IBTRMC),NBLCKB,ND2I,ISP(C),ISP(IC),IJA,ISP(LINK),ISP(IPTR),
     *A,ISP(ID2I),RSP(D2I),IRC)
      IF(IRC.NE.0)THEN
      IERR2=IRC
      IERR=11
      RETURN
      ENDIF
      IF(NBLACK.NE.0)THEN
      CALLPCSBGE(N,IBLKN,ISP(IBLKS),ISP(IBTRM),ISP(IRTBM),ISP(
     *IBTRMC),NBLCKB,NBLACK,ISP(C),ISP(IC),ISP(CP),IJA,ISP(
     *LINK),ISP(IPTR),ISP(IJAB),ISP(IJABP),ISP(ID2I),NZRS,ISP(
     *IJRS),A,RHS,RSP(D2I),RSP(RSRHS),RSP(RS),RSP(Y),RSP(C1DI))
      IF(IBLK.EQ.0)THEN
      CALLPCRSAD(NBLCKB,IBLKN,ISP(IBTRMC),ISP(IJRS))
      ENDIF
      ELSE
      NZRS=0
      ENDIF
      MNEED=MNEED+SPACEN(IBLKN,MAXBLK,NZRB,NZRS,NBLCKB,ND2I,NBLACK
     *,SPHALF)
      IMN=MNEED
      ISCR=0
      RETURN
      END
