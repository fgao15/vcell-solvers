      SUBROUTINEPCEND(ICODE,N,IJA,A,RHS,X,RN,ISP,RSP,PRECON)
      IMPLICITDOUBLEPRECISION(A-H,O-Z)
      INTEGERICODE,N,IJA(*),ISP(*)
      DOUBLEPRECISIONA(*),RHS(*),X(*),RN(*),RSP(*)
      EXTERNALPRECON
      INTEGERIERR,ITMAX,ITEST,KMAX,IFL,IPRE,PBLK,LUDONE,IBLK,
     *MNEED,ITS,RSDONE,NOVERF,RED1,RED2,IERR2,IFRMAT
      COMMON/PCCOM1/IERR,ITMAX,ITEST,KMAX,IFL,IPRE,PBLK,
     *LUDONE,IBLK,MNEED,ITS,RSDONE,NOVERF,RED1,RED2,IERR2,
     *IFRMAT
      SAVE/PCCOM1/
      DOUBLEPRECISIONACCEL,RESID,ACC2
      COMMON/PCCOM2/ACCEL,RESID,ACC2
      SAVE/PCCOM2/
      INTEGERIPRE1,IPRE2,RATIO
      COMMON/PCCOM3/IPRE1,IPRE2,RATIO
      SAVE/PCCOM3/
      INTEGERISTOP,IRESD,INORM,ISAME,ISTATP,IRSDS,IOUT,JOUT,ISTATS,
     *ISTAT1,ISTAT2
      DOUBLEPRECISIONEPS1,EPS2
      COMMON/PCSTIC/ISTOP,IRESD,INORM,ISAME,ISTATP,IRSDS,IOUT,JOUT,
     *ISTATS,ISTAT1,ISTAT2
      COMMON/PCSTRC/EPS1,EPS2
      SAVE/PCSTIC/,/PCSTRC/
      INTEGERNSP,NADR,ONE,LSTRSV,IBASE,I
      INTEGERIOP
      INTEGERIDAMAX
      DOUBLEPRECISIONDNRM2
      DOUBLEPRECISIONRESNEW
      INTEGERSAMRES,ORGRES,OLDRES,COMPAR,R0I,ISTATE(5)
      EQUIVALENCE(SAMRES,ISTATE(1)),(ORGRES,ISTATE(2)),(OLDRES,ISTATE(
     *3)),(COMPAR,ISTATE(4)),(R0I,ISTATE(5))
      ONE=1
      LSTRSV=5
      IF(ICODE.EQ.0)THEN
      NSP=ISP(1)
      NADR=ISP(2)
      OLDRES=NADR+NSP-1
      COMPAR=OLDRES-1
      R0I=COMPAR-1
      IF(IRESD.EQ.1.AND.IPRE2.NE.-4)THEN
      ORGRES=R0I-N
      ELSE
      ORGRES=R0I
      ENDIF
      SAMRES=0
      IRSDS=ORGRES
      IF(ISTATS.NE.0)THEN
      IF(ISTATS.EQ.1)THEN
      IRSDS=ORGRES-2
      ELSE
      IRSDS=ORGRES-ITMAX-1
      ENDIF
      ENDIF
      IBASE=(NADR-1)*RATIO
      DO1I=1,LSTRSV
      ISP(IBASE+I)=ISTATE(I)
1     CONTINUE
      NADR=(IBASE+LSTRSV+RATIO-1)/RATIO+1
      ISP(2)=NADR
      ISP(3)=IRSDS-NADR
      ISP(1)=IRSDS-NADR
      ELSE
      IBASE=(ISP(6)-1)*RATIO
      DO3I=1,LSTRSV
      ISTATE(I)=ISP(IBASE+I)
3     CONTINUE
      IF(IRESD.EQ.1.AND.IPRE2.NE.-4)THEN
      IOP=-IPRE2
      IF(INORM.EQ.-1)THEN
      RESNEW=RN(1)
      ELSE
      CALLDCOPY(N,RN,ONE,RSP(ORGRES),ONE)
      CALLPRECON(IOP,N,IJA,A,RSP(ORGRES),ISP,RSP)
      IF(INORM.EQ.0)THEN
      RESNEW=DNRM2(N,RSP(ORGRES),ONE)
      ELSE
      RESNEW=ABS(RSP(ORGRES-1+IDAMAX(N,RSP(ORGRES),ONE)
     *))
      ENDIF
      ENDIF
      ELSE
      IF(INORM.EQ.0)THEN
      RESNEW=DNRM2(N,RN,ONE)
      ELSE
      IF(INORM.EQ.-1)THEN
      RESNEW=RN(1)
      ELSE
      RESNEW=ABS(RN(IDAMAX(N,RN,ONE)))
      ENDIF
      ENDIF
      ENDIF
      IF(ISTOP.EQ.0)THEN
      IF(ITS.EQ.0)THEN
      IF(RESNEW.EQ.0.0D0)THEN
      RSP(R0I)=0.0D0
      ELSE
      RSP(R0I)=1.0D0/RESNEW
      ENDIF
      ENDIF
      RSP(COMPAR)=RESNEW*RSP(R0I)
      ELSE
      RSP(COMPAR)=RESNEW
      ENDIF
      IF(RSP(COMPAR).LE.EPS1)THEN
      IERR=0
      ELSE
      IF(ITS.GE.ITMAX)THEN
      IERR=1
      ELSE
      IF(ITS.NE.0)THEN
      IF((RSP(OLDRES)-RESNEW)/RSP(OLDRES).LT.EPS2)THEN
      SAMRES=SAMRES+1
      ELSE
      SAMRES=0
      ENDIF
      ENDIF
      IF(SAMRES.GE.ISAME)THEN
      IERR=8
      ELSE
      RSP(OLDRES)=RESNEW
      IERR=-1
      ENDIF
      ENDIF
      ENDIF
      ISP(IBASE+1)=SAMRES
      RESID=RESNEW
      IF(ITS.EQ.0)THEN
      IF(ISTATS.GT.0)THEN
      RSP(IRSDS)=RESNEW
      ENDIF
      IF(ISTAT1.GT.0)THEN
      WRITE(IOUT,1000,ERR=1001)ITS,RESNEW
      ENDIF
      IF(ISTAT2.GT.0)THEN
      WRITE(JOUT,1000,ERR=1002)ITS,RESNEW
      ENDIF
      ELSE
      IF(ISTATS.EQ.2)THEN
      RSP(IRSDS+ITS)=RESNEW
      ENDIF
      IF(ISTAT1.EQ.2)THEN
      WRITE(IOUT,1000,ERR=1001)ITS,RESNEW
      ENDIF
      IF(ISTAT2.EQ.2)THEN
      WRITE(JOUT,1000,ERR=1002)ITS,RESNEW
      ENDIF
      ENDIF
      IF(IERR.GE.0)THEN
      IF(ISTATS.EQ.1)THEN
      RSP(IRSDS+1)=RESNEW
      ENDIF
      IF(ISTAT1.EQ.1)THEN
      WRITE(IOUT,1000,ERR=1001)ITS,RESNEW
      ENDIF
      IF(ISTAT2.EQ.1)THEN
      WRITE(JOUT,1000,ERR=1002)ITS,RESNEW
      ENDIF
      ENDIF
      ENDIF
      RETURN
1000  FORMAT(I10,D16.6)
1001  CONTINUE
      IERR=16
      IERR2=28
      RETURN
1002  CONTINUE
      IERR=16
      IERR2=29
      RETURN
      END
