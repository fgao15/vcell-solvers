      SUBROUTINEPCLUB(MODIFY,N,IJA,A,ISP,RSP,IJL,IJU,LD,U,
     *IRSW,ANADR)
      IMPLICITDOUBLEPRECISION(A-H,O-Z)
      LOGICALMODIFY
      INTEGERN,IJA(*),ISP(*),IJL,IJU,LD,U,IRSW,ANADR
      DOUBLEPRECISIONA(*),RSP(*)
      INTEGERIERR,ITMAX,ITEST,KMAX,IFL,IPRE,PBLK,LUDONE,IBLK,
     *MNEED,ITS,RSDONE,NOVERF,RED1,RED2,IERR2,IFRMAT
      COMMON/PCCOM1/IERR,ITMAX,ITEST,KMAX,IFL,IPRE,PBLK,
     *LUDONE,IBLK,MNEED,ITS,RSDONE,NOVERF,RED1,RED2,IERR2,
     *IFRMAT
      SAVE/PCCOM1/
      INTEGERIPRE1,IPRE2,RATIO
      COMMON/PCCOM3/IPRE1,IPRE2,RATIO
      SAVE/PCCOM3/
      INTEGERISRT,IJASGN,ISX0,IFORM
      COMMON/PCVERI/ISRT,IJASGN,ISX0,IFORM
      SAVE/PCVERI/
      INTEGERROW,IROW,IBLKN,IBLKS,MAXBLK,IPVT,IJLB,IJUB,IBTRM,JCOL
      INTEGERLDR,UR,IJUR,ALAST,AILAST,I,IJAB
      INTEGERANFREE,AINADR,IUT,NZRB,NZLB,NZUB,NZRBMX,NZMAX,
     *LEVL,NZL,NZU,IRTBM,NZR,LAST,IBASE,SCRN,SPCN,
     *ISTATE(19),NZLUMX
      EQUIVALENCE(NZL,ISTATE(1)),(NZU,ISTATE(2)),(IBLKN,ISTATE(3)),(
     *IBLKS,ISTATE(4)),(IBTRM,ISTATE(5)),(IJLB,ISTATE(6)),(IJUB,ISTATE
     *(7)),(IJUR,ISTATE(8)),(LDR,ISTATE(9)),(UR,ISTATE(10)),(IROW,
     *ISTATE(11)),(IPVT,ISTATE(12)),(JCOL,ISTATE(13)),(ROW,ISTATE(14)),
     *(NZRB,ISTATE(15)),(ALAST,ISTATE(16)),(MAXBLK,ISTATE(17)),
     *(NZLB,ISTATE(18)),(NZUB,ISTATE(19))
      INTEGERKIBLKN,KNZL,KNZU,KNZLB,KNZUB,KMXBLK,KNZRB,SPIUT,SPIROW
      SPCN(KIBLKN,KNZL,KNZU,KNZLB,KNZUB)=(LAST+2*KIBLKN+N+KNZL+
     *KNZU+KNZLB+KNZUB+RATIO)/RATIO+KNZL+KNZU-N-1
      SCRN(KIBLKN,KMXBLK,KNZL,KNZU,KNZLB,KNZUB,KNZRB)=MAX((KNZRB+(2+
     *SPIUT)*MAX(KNZLB,KNZUB)-(KNZLB+KNZUB)+KIBLKN+RATIO-1)/RATIO-
     *KNZL-KNZU+N+1,(SPIROW+N+KMXBLK+2*MAX(KNZL,KNZU)-(KNZL+KNZU
     *)+RATIO-1)/RATIO+2*MAX(KNZL,KNZU)-(KNZL+KNZU)+KMXBLK*N)
      LAST=19
      IF(IFL.EQ.-1)THEN
      SPIUT=0
      ELSE
      SPIUT=1
      ENDIF
      IF(MODIFY)THEN
      SPIROW=N
      ELSE
      SPIROW=0
      ENDIF
      IF(LUDONE.NE.0)THEN
      IBASE=(ANADR-1)*RATIO
      DO1I=1,LAST
      ISTATE(I)=ISP(IBASE+I)
1     CONTINUE
      NZLUMX=((ROW+N)*RATIO-(IJL-1))/(2*(1+RATIO))
      IF(IJASGN.EQ.0)THEN
      CALLPCIABS(N,IJA)
      ENDIF
      ELSE
      ANADR=ISP(2)
      ANFREE=ISP(1)
      IBASE=(ANADR-1)*RATIO
      AINADR=IBASE+1
      ALAST=ANADR+ANFREE
      AILAST=AINADR+ANFREE*RATIO
      IF((LAST-1+RATIO)/RATIO.GT.ANFREE)THEN
      IERR=3
      MAXBLK=IBLK
      IF(IBLK.LT.1)THEN
      MAXBLK=2
      ENDIF
      NZR=IJA(N+1)-1
      NZRB=NZR/(IBLK*IBLK)
      IBLKN=N/MAXBLK
      NZLB=((NZRB-IBLKN)*(1+IFL)+IBLKN)
      NZUB=NZLB
      NZL=NZLB*MAXBLK*MAXBLK
      NZU=NZL
      ISP(1)=ANFREE-SPCN(IBLKN,NZL,NZU,NZLB,NZUB)
      ISP(3)=ISP(1)-SCRN(IBLKN,MAXBLK,NZL,NZU,NZLB,NZUB,NZRB)
      RETURN
      ENDIF
      IRSW=AINADR+LAST
      IBLKS=IRSW+N
      IF(IBLKS+N.GT.AILAST)THEN
      MAXBLK=IBLK
      IF(IBLK.LT.1)THEN
      MAXBLK=2
      ENDIF
      NZR=IJA(N+1)-1
      NZRB=NZR/(IBLK*IBLK)
      IBLKN=N/MAXBLK
      NZLB=((NZRB-IBLKN)*(1+IFL)+IBLKN)/2
      NZUB=NZLB
      NZL=NZLB*MAXBLK*MAXBLK
      NZU=NZL
      ISP(1)=ANFREE-SPCN(IBLKN,NZL,NZU,NZLB,NZUB)
      ISP(3)=ISP(1)-SCRN(IBLKN,MAXBLK,NZL,NZU,NZLB,NZUB,NZRB)
      IERR=3
      RETURN
      ENDIF
      CALLPCIBLK(N,IBLK,IJA,IBLKN,MAXBLK,ISP(IBLKS))
      LEVL=AILAST-IBLKN
      IRTBM=LEVL-N
      IBTRM=IBLKS+IBLKN
      IF(IRTBM.LT.IBTRM+IBLKN+1)THEN
      NZR=IJA(N+1)-1
      NZRB=NZR/(MAXBLK*MAXBLK)
      NZLB=((NZRB-IBLKN)*(1+IFL)+IBLKN)/2
      NZUB=NZLB
      NZL=NZLB*MAXBLK*MAXBLK
      NZU=NZL
      ISP(1)=ANFREE-SPCN(IBLKN,NZL,NZU,NZLB,NZUB)
      ISP(3)=ISP(1)-SCRN(IBLKN,MAXBLK,NZL,NZU,NZLB,NZUB,NZRB)
      IERR=3
      RETURN
      ENDIF
      CALLPCBTRC(N,IBLKN,IBLK,ISP(IBLKS),ISP(IBTRM),ISP(IRTBM))
      IJAB=IBTRM+IBLKN+1
      NZRBMX=IRTBM-IJAB
      CALLPCIJAB(N,IJA,IBLKN,NZRBMX,ISP(IBLKS),ISP(IRTBM),ISP(IJAB)
     *,ISP(LEVL))
      IF(IERR.NE.0)THEN
      NZRB=NZRBMX
      NZLB=((NZRB-IBLKN)*(1+IFL)+IBLKN)/2
      NZUB=NZLB
      NZL=NZLB*MAXBLK*MAXBLK
      NZU=NZL
      ISP(1)=ANFREE-SPCN(IBLKN,NZL,NZU,NZLB,NZUB)
      ISP(3)=ISP(1)-SCRN(IBLKN,MAXBLK,NZL,NZU,NZLB,NZUB,NZRB)
      IERR=3
      RETURN
      ENDIF
      NZRB=ISP(IJAB+IBLKN)-1
      IJLB=IJAB+NZRB
      NZMAX=(IRTBM-IJLB)/(2+SPIUT)
      IUT=IJLB+NZMAX*SPIUT
      IJUB=IUT+NZMAX
      CALLPCILUZ(IBLKN,ISP(IJAB),IFL,NZMAX,NZLB,NZUB,ISP(IJLB)
     *,ISP(IJUB),ISP(IUT),ISP(LEVL))
      NZL=NZLB*MAXBLK*MAXBLK
      NZU=NZUB*MAXBLK*MAXBLK
      IF(IERR.NE.0)THEN
      ISP(1)=ANFREE-SPCN(IBLKN,NZL,NZU,NZLB,NZUB)
      ISP(3)=ISP(1)-SCRN(IBLKN,MAXBLK,NZL,NZU,NZLB,NZUB,NZRB)
      RETURN
      ENDIF
      CALLPCICPY(NZLB,ISP(IJLB),ISP(IJAB))
      IJLB=IJAB
      CALLPCICPY(NZUB,ISP(IJUB),ISP(IJLB+NZLB))
      IJUB=IJLB+NZLB
      IJL=IJUB+NZUB
      IROW=AILAST-SPIROW
      JCOL=IROW-N
      IPVT=JCOL-MAXBLK
      ROW=(IPVT+RATIO-1)/RATIO-MAXBLK*N
      NZLUMX=((ROW+N)*RATIO-(IJL-1))/(2*(1+RATIO))
      IJUR=IJL+NZLUMX
      LDR=ROW-NZLUMX
      UR=LDR-NZLUMX
      DO3I=1,LAST
      ISP(IBASE+I)=ISTATE(I)
3     CONTINUE
      ENDIF
      CALLPC0V(N*MAXBLK,RSP(ROW))
      CALLPCLUBF(MODIFY,N,IJA,IBLKN,NZLUMX,ISP(IBLKS),ISP(IBTRM
     *),ISP(IJLB),ISP(IJUB),A,ISP(IJL),ISP(IJUR),ISP(IRSW),RSP(
     *LDR),RSP(UR),ISP(IROW),ISP(IPVT),ISP(JCOL),RSP(ROW))
      IF(IERR.NE.0)THEN
      NZL=NZLUMX
      NZU=NZLUMX
      ELSE
      NZL=ISP(IJL+N)-1
      NZU=ISP(IJUR+N)-1
      ENDIF
      LD=ALAST-NZL
      U=LD-NZU
      IJU=IJL+NZL
      ISP(2)=(IJU+NZU+RATIO-2)/RATIO+1
      ISP(1)=U+N+1-ISP(2)
      ISP(3)=ISP(1)-SCRN(IBLKN,MAXBLK,NZL,NZU,NZLB,NZUB,NZRB)
      IF(IERR.NE.0)THEN
      RETURN
      ENDIF
      CALLPCRCPR(NZL,RSP(LDR),RSP(LD))
      CALLPCRCPR(NZU,RSP(UR),RSP(U))
      CALLPCICPY(NZU,ISP(IJUR),ISP(IJU))
      RETURN
      END
