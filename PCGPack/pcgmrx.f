      SUBROUTINEPCGMRX(N,IMP1,IJA,A,RHS,X,SS,VEC,HH,C,S,
     *RS,VNRM,W,ISP,RSP,PRECON,PCSTOP,PCMV)
      IMPLICITDOUBLEPRECISION(A-H,O-Z)
      INTEGERN,IMP1,IJA(*),ISP(*)
      DOUBLEPRECISIONA(*),RHS(*),X(*),SS(N,*),VEC(*),
     *HH(IMP1,*),C(*),S(*),RS(*),VNRM(*),W(*),RSP(*)
      EXTERNALPRECON,PCSTOP,PCMV
      INTEGERIERR,ITMAX,ITEST,KMAX,IFL,IPRE,PBLK,
     *LUDONE,IBLK,MNEED,ITS,RSDONE,NOVERF,
     *RED1,RED2,IERR2,IFRMAT
      COMMON/PCCOM1/IERR,ITMAX,ITEST,KMAX,IFL,IPRE,PBLK,
     *LUDONE,IBLK,MNEED,ITS,RSDONE,NOVERF,
     *RED1,RED2,IERR2,IFRMAT
      SAVE/PCCOM1/
      INTEGERIPRE1,IPRE2,RATIO
      COMMON/PCCOM3/IPRE1,IPRE2,RATIO
      SAVE/PCCOM3/
      INTEGERISRT,IJASGN,ISX0,IFORM
      COMMON/PCVERI/ISRT,IJASGN,ISX0,IFORM
      SAVE/PCVERI/
      LOGICALHEND
      INTEGERI,J,I1,IT,K,K1,LOCITS,ONE,JJ,IM,IMP2,LTEST,
     *IMT,IMC,IML
      DOUBLEPRECISIONTOLNOR,TET,HINORM,T,GAM,DNRM2,DDOT
      ONE=1
      TOLNOR=1.D+05
      TET=9.765625D-04
      IM=IMP1-1
      IMP2=IMP1+1
      ITS=0
      IF(ISX0.NE.1)THEN
      CALLPCMV(N,IJA,A,X,SS)
      CALLPCVSUB(N,SS,RHS)
      ELSE
      CALLDCOPY(N,RHS,ONE,SS,ONE)
      ENDIF
      RS(IMP2)=DNRM2(N,SS,1)
      IF(RS(IMP2).EQ.0.0D0)THEN
      IERR=0
      RETURN
      ENDIF
      IF(IPRE2.NE.-4)THEN
      CALLPRECON(IPRE2,N,IJA,A,SS,ISP,RSP)
      RS(IMP2)=DNRM2(N,SS,1)
      ENDIF
      CALLPCSTOP(ONE,N,IJA,A,RHS,X,RS(IMP2),ISP,RSP,PRECON)
      IF(IERR.GE.0)THEN
      RETURN
      ENDIF
      IF(IPRE1.NE.-4.AND.ISX0.NE.1)THEN
      CALLPRECON(-IPRE1,N,IJA,A,X,ISP,RSP)
      ENDIF
      LTEST=ITEST
      IMC=ITMAX+IM
      DO1LOCITS=1,ITMAX,IM
      VNRM(1)=1.0D0/RS(IMP2)
      RS(1)=RS(IMP2)
      IMC=IMC-IM
      IMT=MIN(IM,IMC)
      CALLPC0V(IMP1*IM,HH)
      IML=IMT
      DO3I=1,IMT
      ITS=ITS+1
      I1=I+1
      IF(IPRE1.NE.-4)THEN
      CALLDCOPY(N,SS(1,I),ONE,VEC,ONE)
      CALLPCOP(N,IJA,A,VEC,SS(1,I1),ISP,RSP,PRECON,PCMV)
      ELSE
      CALLPCOP(N,IJA,A,SS(1,I),SS(1,I1),ISP,RSP,PRECON,PCMV)
      ENDIF
      DO5IT=1,2
      HINORM=0.0D0
      DO7J=1,I
      T=DDOT(N,SS(1,I1),1,SS(1,J),1)
      HINORM=HINORM+T*VNRM(J)*VNRM(J)*T
      HH(J,I)=HH(J,I)+T*VNRM(J)*VNRM(I)
      T=-T*VNRM(J)*VNRM(J)
      CALLDAXPY(N,T,SS(1,J),1,SS(1,I1),1)
 7    CONTINUE
      T=DNRM2(N,SS(1,I1),1)
      IF(T.EQ.0.0D0)THEN
      HEND=.TRUE.
      GOTO6
      ELSE
      HEND=.FALSE.
      ENDIF
      IF(T.GT.HINORM*TET/T/I.AND.IT.EQ.1)THEN
      GOTO6
      ENDIF
5     CONTINUE
6     CONTINUE
      IF(.NOT.HEND)THEN
      HH(I1,I)=T*VNRM(I)
      VNRM(I1)=1.0D0/T
      IF((T+RS(IMP2)/T).GT.TOLNOR*N)THEN
      T=1.0D0/T
      CALLDSCAL(N,T,SS(1,I1),1)
      VNRM(I1)=1.0D0
      ENDIF
      ENDIF
      DO9K=2,I
      K1=K-1
      T=HH(K1,I)
      HH(K1,I)=C(K1)*T+S(K1)*HH(K,I)
      HH(K,I)=-S(K1)*T+C(K1)*HH(K,I)
9     CONTINUE
      IF(HEND)THEN
      RS(IMP2)=0.0D0
      ELSE
      GAM=SQRT(HH(I,I)*HH(I,I)+HH(I1,I)*HH(I1,I))
      IF(GAM.NE.0.0D0)THEN
      C(I)=HH(I,I)/GAM
      S(I)=HH(I1,I)/GAM
      ELSE
      C(I)=1.0D0
      S(I)=0.0D0
      ENDIF
      RS(I1)=-S(I)*RS(I)
      RS(I)=C(I)*RS(I)
      HH(I,I)=C(I)*HH(I,I)+S(I)*HH(I1,I)
      RS(IMP2)=ABS(RS(I1))
      ENDIF
      LTEST=LTEST-1
      IF(LTEST.EQ.0.OR.HEND)THEN
      LTEST=ITEST
      CALLPCSTOP(ONE,N,IJA,A,RHS,X,RS(IMP2),ISP,RSP,PRECON)
      IF(IERR.GE.0)THEN
      IML=I
      GOTO4
      ENDIF
      ENDIF
3     CONTINUE
4     CONTINUE
      IF(HH(IML,IML).EQ.0.0D0)THEN
      IML=IML-1
      ENDIF
      RS(IML)=RS(IML)/HH(IML,IML)
      DO11K=IML-1,1,-1
      T=RS(K)
      DO13J=K+1,IML
      T=T-HH(K,J)*RS(J)
13    CONTINUE
      RS(K)=T/HH(K,K)
11    CONTINUE
      CALLPCVMUL(IML,W,RS,VNRM)
      DO15J=1,IML
      CALLDAXPY(N,W(J),SS(1,J),1,X,1)
15    CONTINUE
      IF(IERR.GE.0)THEN
      GOTO2
      ENDIF
      IF(ITS.GE.ITMAX)THEN
      CALLPCSTOP(ONE,N,IJA,A,RHS,X,RS(IMP2),ISP,RSP,PRECON)
      GOTO2
      ENDIF
      DO17J=1,IMT
      JJ=IMT+2-J
      RS(JJ-1)=-S(JJ-1)*RS(JJ)
      RS(JJ)=C(JJ-1)*RS(JJ)
17    CONTINUE
      CALLPCVMUL(IMT+1,W,RS,VNRM)
      CALLDSCAL(N,W(1),SS,ONE)
      DO19J=2,IMT+1
      CALLDAXPY(N,W(J),SS(1,J),1,SS,1)
19    CONTINUE
      RS(IMP2)=DNRM2(N,SS,1)
      IF(RS(IMP2).EQ.0.0D0)THEN
      IF(LTEST.NE.0.AND..NOT.HEND)THEN
      CALLPCSTOP(ONE,N,IJA,A,RHS,X,RS(IMP2),ISP,RSP,PRECON)
      ENDIF
      GOTO2
      ENDIF
1     CONTINUE
2     CONTINUE
      IF(IPRE1.NE.-4)THEN
      CALLPRECON(IPRE1,N,IJA,A,X,ISP,RSP)
      ENDIF
      RETURN
      END
