      SUBROUTINEPCICB(MODIFY,N,IJA,A,ISP,RSP,IJU,UD)
      IMPLICITDOUBLEPRECISION(A-H,O-Z)
      LOGICALMODIFY
      INTEGERN,IJA(*),ISP(*),IJU,UD
      DOUBLEPRECISIONA(*),RSP(*)
      INTEGERIERR,ITMAX,ITEST,KMAX,IFL,IPRE,PBLK,LUDONE,IBLK,
     *MNEED,ITS,RSDONE,NOVERF,RED1,RED2,IERR2,IFRMAT
      COMMON/PCCOM1/IERR,ITMAX,ITEST,KMAX,IFL,IPRE,PBLK,
     *LUDONE,IBLK,MNEED,ITS,RSDONE,NOVERF,RED1,RED2,IERR2,
     *IFRMAT
      SAVE/PCCOM1/
      INTEGERIPRE1,IPRE2,RATIO
      COMMON/PCCOM3/IPRE1,IPRE2,RATIO
      SAVE/PCCOM3/
      INTEGERISRT,IJASGN,ISX0,IFORM
      COMMON/PCVERI/ISRT,IJASGN,ISX0,IFORM
      SAVE/PCVERI/
      LOGICALLOWER,UPPER,FULL,HALF,SYMMAT
      COMMON/PCVERL/LOWER,UPPER,FULL,HALF,SYMMAT
      SAVE/PCVERL/
      INTEGERROW
      INTEGERANADR,ANFREE,AINADR,ALAST,AILAST,NZA,NZMAX,LEVL,
     *IPT,JL,IFC,NZU,NSP1,SPCN,SCRN,LINKA,IJAR,IUT,MARK,NZUB
     *,NZAB,IBLKS,IBLKN,MAXBLK,IBTRM,IRTBM,IJAB,IJUB,SISRT
      INTEGERSPIUT,SPJL,SPIFC,SPLEVL,SPIPT,SPMARK,SPLOW,SP1,SPIJAR
      INTEGERKNZU,KSPLOW,KSP1,KNZUB,KIBLKN,KSPMAR,KSPIUT,KNZAB
      INTEGERMAX
      SPCN(KNZU)=(KNZU+RATIO-1)/RATIO+KNZU
      SCRN(KNZU,KNZUB,KNZAB,KIBLKN,KSPLOW,KSP1,KSPIUT,KSPMAR)=(KSPLOW
     *+MAX(MAX(0,KSPIUT*KNZUB+KSP1*KIBLKN+KNZAB-KNZU)+MAX(0,N+
     *KIBLKN+1+MAX(KNZUB,N+KIBLKN)-RATIO*KNZU),(2+KSPMAR+RATIO)*N)+
     *RATIO-1)/RATIO
      NZA=IJA(N+1)-1
      IF(MODIFY)THEN
      SPMARK=1
      ELSE
      SPMARK=0
      ENDIF
      IF(LOWER)THEN
      SPLOW=2*NZA
      SPIJAR=1
      ELSE
      SPLOW=0
      SPIJAR=0
      ENDIF
      IF(IFL.EQ.-1)THEN
      SPIUT=0
      SPIFC=0
      SPJL=0
      SPIPT=0
      SPLEVL=0
      ELSEIF(IFL.EQ.0)THEN
      SPIFC=0
      SPJL=0
      SPIPT=0
      IF(LOWER)THEN
      SPLEVL=1
      SPIUT=0
      ELSE
      IF(ISRT.EQ.1)THEN
      SPLEVL=0
      SPIUT=0
      ELSE
      SPIUT=1
      SPLEVL=1
      ENDIF
      ENDIF
      ELSE
      SPIUT=1
      SPIFC=1
      SPJL=1
      SPIPT=1
      SPLEVL=1
      ENDIF
      SP1=SPIFC+SPJL+SPIPT+SPLEVL
      IF(LUDONE.NE.0)THEN
      IF(IJASGN.EQ.0)THEN
      CALLPCIABS(N,IJA)
      ENDIF
      NZU=ISP(IJU+N)-1
      IF(LOWER)THEN
      IJAR=IJU+NZU+(2+SPMARK)*N
      LINKA=IJAR+NZA
      CALLPCICTR(N,IJA,ISP(IJAR),ISP(LINKA))
      ENDIF
      ELSE
      ANADR=ISP(2)
      ANFREE=ISP(1)
      AINADR=(ANADR-1)*RATIO+1
      ALAST=ANADR+ANFREE
      AILAST=AINADR+ANFREE*RATIO
      LINKA=AILAST-NZA*SPIJAR
      IJAR=LINKA-NZA*SPIJAR
      IBLKS=IJAR-N
      IF(IBLKS.LT.AINADR)THEN
      MAXBLK=IBLK
      IF(MAXBLK.EQ.0)THEN
      MAXBLK=2
      ENDIF
      IBLKN=N/MAXBLK
      IF(FULL)THEN
      NZAB=NZA/2/(MAXBLK*MAXBLK)
      ELSE
      NZAB=NZA/(MAXBLK*MAXBLK)
      ENDIF
      NZUB=(NZAB-IBLKN)*(1+IFL)+IBLKN
      NZU=NZUB*MAXBLK*MAXBLK
      ISP(1)=ANFREE-SPCN(NZU)
      ISP(3)=ISP(1)-SCRN(NZU,NZUB,NZAB,IBLKN,SPLOW,SP1,SPIUT,
     *SPMARK)
      IERR=3
      RETURN
      ENDIF
      IF(LOWER)THEN
      CALLPCICTR(N,IJA,ISP(IJAR),ISP(LINKA))
      ENDIF
      CALLPCIBLK(N,IBLK,IJA,IBLKN,MAXBLK,ISP(IBLKS))
      IBTRM=IBLKS-IBLKN-1
      IRTBM=IBTRM-N
      MARK=IRTBM-IBLKN
      IJAB=AINADR
      IF(MARK-IJAB.LT.NZA)THEN
      IF(FULL)THEN
      NZAB=NZA/2/(MAXBLK*MAXBLK)
      ELSE
      NZAB=NZA/(MAXBLK*MAXBLK)
      ENDIF
      NZUB=(NZAB-IBLKN)*(1+IFL)+IBLKN
      NZU=NZUB*MAXBLK*MAXBLK
      ISP(1)=ANFREE-SPCN(NZU)
      ISP(3)=ISP(1)-SCRN(NZU,NZUB,NZAB,IBLKN,SPLOW,SP1,SPIUT,
     *SPMARK)
      IERR=3
      RETURN
      ENDIF
      CALLPCBTRC(N,IBLKN,IBLK,ISP(IBLKS),ISP(IBTRM),ISP(IRTBM))
      SISRT=ISRT
      ISRT=0
      CALLPCSIJB(N,IJA,ISP(IJAR),ISP(LINKA),IBLKN,ISP(IBLKS),ISP(
     *IRTBM),A(N+1),ISP(IJAB),ISP(MARK))
      ISRT=SISRT
      NZAB=ISP(IJAB+IBLKN)-1
      JL=IJAB+NZAB
      IFC=JL+SPJL*IBLKN
      LEVL=IFC+SPIFC*IBLKN
      IPT=LEVL+SPLEVL*IBLKN
      IUT=IPT+SPIPT*IBLKN
      NZMAX=(IBTRM-IUT)/2
      IJUB=IUT+NZMAX
      IF(NZMAX.LE.0)THEN
      NZUB=(NZAB-IBLKN)*(1+IFL)+IBLKN
      NZU=NZUB*MAXBLK*MAXBLK
      ISP(1)=ANFREE-SPCN(NZU)
      ISP(3)=ISP(1)-SCRN(NZU,NZUB,NZAB,IBLKN,SPLOW,SP1,SPIUT,
     *SPMARK)
      IERR=3
      RETURN
      ENDIF
      CALLPCPCSF(IBLKN,ISP(IJAB),ISP(IJAB),ISP(IJAB),IFL,NZMAX,
     *NZUB,ISP(IJUB),ISP(IUT),ISP(JL),ISP(IFC),ISP(LEVL),
     *ISP(
     *IPT))
      IF(IERR.EQ.3)THEN
      NZU=NZUB*MAXBLK*MAXBLK
      ISP(1)=ANFREE-SPCN(NZU)
      ISP(3)=ISP(1)-SCRN(NZU,NZUB,NZAB,IBLKN,SPLOW,SP1,SPIUT,
     *SPMARK)
      ENDIF
      IF(IERR.NE.0)THEN
      RETURN
      ENDIF
      IF(NZMAX+IUT-IJAB.LT.NZUB*MAXBLK*MAXBLK)THEN
      CALLPCICPR(NZUB,ISP(IJUB),ISP(IBTRM-NZUB))
      IJUB=IBTRM-NZUB
      ENDIF
      NZMAX=IJUB-IJAB
      IJU=IJAB
      CALLPCIJUP(N,IBLKN,ISP(IBTRM),ISP(IJUB),ISP(IJU),NZMAX)
      IF(NZMAX.LT.0)THEN
      NZU=-NZMAX
      ISP(1)=ANFREE-SPCN(NZU)
      ISP(3)=ISP(1)-SCRN(NZU,NZUB,NZAB,IBLKN,SPLOW,SP1,SPIUT,
     *SPMARK)
      IERR=3
      RETURN
      ENDIF
      NZU=ISP(IJU+N)-1
      IF(LOWER)THEN
      CALLPCICPY(NZA,ISP(IJAR),ISP(IJU+NZU+(2+SPMARK)*N))
      IJAR=IJU+NZU+(2+SPMARK)*N
      CALLPCICPY(NZA,ISP(LINKA),ISP(IJAR+NZA))
      LINKA=IJAR+NZA
      IF(AILAST-RATIO*(NZU+N)-(2+SPMARK)*N.LT.LINKA+NZA
     *)THEN
      IERR=3
      ISP(1)=ANFREE-SPCN(NZU)
      ISP(3)=ISP(1)-SCRN(NZU,NZUB,NZAB,IBLKN,SPLOW,SP1,
     *SPIUT,SPMARK)
      RETURN
      ENDIF
      ELSE
      IF(AILAST-(2+SPMARK)*N-RATIO*(NZU+N).LT.IJU+NZU)THEN
      IERR=3
      ISP(1)=ANFREE-SPCN(NZU)
      ISP(3)=ISP(1)-SCRN(NZU,NZUB,NZAB,IBLKN,SPLOW,SP1,
     *SPIUT,SPMARK)
      RETURN
      ENDIF
      ENDIF
      ENDIF
      UD=ALAST-NZU
      ROW=UD-N
      JL=IJU+NZU
      IFC=JL+N
      MARK=IFC+SPMARK*N
      ISP(2)=(JL+RATIO-2)/RATIO+1
      ISP(1)=UD-ISP(2)
      NSP1=ISP(1)-SCRN(NZU,NZUB,NZAB,IBLKN,SPLOW,SP1,SPIUT,
     *SPMARK)
      ISP(3)=NSP1
      IF(NSP1.LT.0)THEN
      IERR=3
      RETURN
      ENDIF
      CALLPCPCNF(MODIFY,N,IJA,ISP(IJAR),ISP(LINKA),ISP(IJU),A,
     *RSP(UD),ISP(JL),ISP(IFC),ISP(MARK),RSP(ROW))
      RETURN
      END
