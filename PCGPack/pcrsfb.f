      SUBROUTINEPCRSFB(N,IJA,A,RHS,ISP,RSP,IC,C,CP,NBLCKB,
     *NBLACK,IJAB,IBLKN,IBLKS,IBTRM,IRTBM,IBTRMC,IPVT,ID2I,D2I
     *,NZRS,IJRS,RS,RSRHS,Y,IMN,ISCR,RSNADR,NSP1)
      IMPLICITDOUBLEPRECISION(A-H,O-Z)
      INTEGERN,IJA(*),ISP(*),IC,C,CP,NBLCKB,NBLACK,IJAB,
     *IBLKN,IBLKS,IBTRM,IRTBM,IBTRMC,IPVT,ID2I,D2I,
     *NZRS,IJRS,RS,RSRHS,Y,IMN,ISCR,RSNADR,NSP1
      DOUBLEPRECISIONA(*),RHS(*),RSP(*)
      INTEGERIERR,ITMAX,ITEST,KMAX,IFL,IPRE,PBLK,LUDONE,IBLK,
     *MNEED,ITS,RSDONE,NOVERF,RED1,RED2,IERR2,IFRMAT
      COMMON/PCCOM1/IERR,ITMAX,ITEST,KMAX,IFL,IPRE,PBLK,
     *LUDONE,IBLK,MNEED,ITS,RSDONE,NOVERF,RED1,RED2,IERR2,
     *IFRMAT
      SAVE/PCCOM1/
      INTEGERIPRE1,IPRE2,RATIO
      COMMON/PCCOM3/IPRE1,IPRE2,RATIO
      SAVE/PCCOM3/
      INTEGERINADR,MAXBLK,ND2I,IJRSB,NZRSMX,NZRB,MARK,ROW,FIC,
     *AILAST,NZR,NZRSB,NZRBMX,C1DI,NRED,NREDB,NSP,NADR
      INTEGERPRMSP
      SAVEND2I,MAXBLK,NZRB
      PRMSP(NZRB,ND2I)=NZRS+ND2I+N+NBLACK+
     1(IBLKS+6*IBLKN+2*N+NZRB+NZRS-NBLCKB+1+RATIO)/RATIO
      NADR=ISP(2)
      NSP=ISP(1)+NADR-1
      IF(RSDONE.EQ.0)THEN
      NZR=IJA(N+1)-1
      IF(NSP*RATIO.LT.N)THEN
      MAXBLK=IBLK
      IF(IBLK.LT.1)THEN
      MAXBLK=2
      ENDIF
      IBLKN=(N+MAXBLK-1)/MAXBLK
      NBLACK=N/2
      NBLCKB=NBLACK/MAXBLK
      NZRB=NZR/(MAXBLK*MAXBLK)
      ND2I=NBLACK*MAXBLK
      NZRS=NZR
      IMN=PRMSP(NZRB,ND2I)
      ISCR=MAXBLK
      MNEED=IMN+ISCR-NSP
      IERR=10
      RETURN
      ENDIF
      CALLPCIBLK(N,IBLK,IJA,IBLKN,MAXBLK,ISP(IBLKS))
      IRTBM=IBLKS+IBLKN
      IBTRM=IRTBM+N
      IBTRMC=IBTRM+IBLKN+1
      IC=IBTRMC+IBLKN+1
      C=IC+IBLKN
      IJAB=C+IBLKN
      AILAST=NSP*RATIO+1
      MARK=AILAST-IBLKN
      IF(IJAB+NZR.GT.MARK)THEN
      NBLACK=N/2
      NBLCKB=NBLACK/MAXBLK
      NZRB=NZR/(MAXBLK*MAXBLK)
      NZRS=NZR
      ND2I=NBLACK*MAXBLK
      IMN=PRMSP(NZRB,ND2I)
      ISCR=MAXBLK
      MNEED=IMN+ISCR-NSP
      IERR=10
      RETURN
      ENDIF
      CALLPCBTRC(N,IBLKN,IBLK,ISP(IBLKS),ISP(IBTRM),ISP(IRTBM))
      NZRBMX=MARK-IJAB
      CALLPCIJAB(N,IJA,IBLKN,NZRBMX,ISP(IBLKS),ISP(IRTBM),ISP(IJAB)
     *,ISP(MARK))
      IF(IERR.NE.0)THEN
      NBLACK=N/2
      NBLCKB=NBLACK/MAXBLK
      NZRB=NZRBMX
      NZRS=NZR
      ND2I=NBLACK*MAXBLK
      IMN=PRMSP(NZRB,ND2I)
      ISCR=MAXBLK
      MNEED=IMN+ISCR-NSP
      IERR=10
      RETURN
      ENDIF
      NZRB=ISP(IJAB+IBLKN)-1
      CP=IJAB+NZRB
      INADR=CP+NZRB
      NADR=(INADR-1)*RATIO+1
      IF(NADR.GT.NSP)THEN
      NBLACK=N/2
      NBLCKB=NBLACK/MAXBLK
      NZRS=NZR
      ND2I=NBLACK*MAXBLK
      IMN=PRMSP(NZRB,ND2I)
      ISCR=MAXBLK
      MNEED=IMN+ISCR-NSP
      IERR=10
      RETURN
      ENDIF
      CALLPCRSRB(IBLKN,ISP(IBLKS),ISP(IBTRM),ISP(IJAB),ND2I,
     *NBLCKB,NBLACK,ISP(C),ISP(IC),ISP(IBTRMC),ISP(CP))
      IF(IERR.NE.0)RETURN
      NRED=N-NBLACK
      NREDB=IBLKN-NBLCKB
      FIC=MARK-NBLCKB
      IJRSB=CP+NBLACK
      NZRSMX=FIC-IJRSB
      IF(NZRSMX.LT.NBLCKB+1)THEN
      NZRS=NZR
      IMN=PRMSP(NZRB,ND2I)
      ISCR=MAXBLK
      MNEED=IMN+ISCR-NSP
      IERR=10
      RETURN
      ENDIF
      IF(NBLCKB.NE.0)THEN
      CALLPCRSPS(IBLKN,NZRSMX,NBLCKB,ISP(C),ISP(IC),ISP(
     *IJAB),NZRSB,ISP(IJRSB),ISP(MARK),ISP(FIC))
      IF(IERR.NE.0)THEN
      NZRS=MAX(NZRSMX,NZR)
      IMN=PRMSP(NZRB,ND2I)
      ISCR=MAXBLK
      MNEED=IMN+ISCR-NSP
      IERR=10
      RETURN
      ENDIF
      ELSE
      NZRS=0
      NZRSB=0
      ENDIF
      CALLPCICPY(NZRSB,ISP(IJRSB),ISP(AILAST-NZRSB))
      IJRS=IJRSB
      IJRSB=AILAST-NZRSB
      NZRSMX=IJRSB-IJRS
      CALLPCRSBS(IBLKN,NBLCKB,ISP(IJRSB),NZRSMX,ISP(IBTRMC),ISP(
     *IJRS),NZRS)
      IF(IERR.NE.0)THEN
      NZRS=MAX(NZRSMX,NZR)
      IMN=PRMSP(NZRB,ND2I)
      ISCR=MAXBLK
      MNEED=IMN+ISCR-NSP
      IERR=10
      RETURN
      ENDIF
      IPVT=IJRS+NZRS
      ID2I=IPVT+NRED
      NADR=(ID2I+NREDB+RATIO-1)/RATIO+1
      RSNADR=NADR
      RSRHS=NSP+1-NBLACK
      D2I=RSRHS-ND2I
      RS=D2I-NZRS
      Y=RS-N
      NSP1=Y-NADR
      IF(NSP1.LT.MAXBLK)THEN
      IMN=PRMSP(NZRB,ND2I)
      ISCR=MAXBLK
      MNEED=IMN+ISCR-NSP
      IERR=10
      RETURN
      ENDIF
      ENDIF
      CALLPCRSLU(IBLKN,ISP(IBLKS),ISP(IBTRM),ISP(IRTBM),ISP(IBTRMC
     *),NBLCKB,ND2I,ISP(C),ISP(IC),IJA,A,ISP(ID2I),ISP(IPVT),
     *RSP(D2I))
      IF(IERR.NE.0)THEN
      RETURN
      ENDIF
      ROW=Y
      C1DI=ROW-MAXBLK
      IF(NBLACK.NE.0)THEN
      CALLPCRSFM(N,IBLKN,ISP(IBLKS),ISP(IBTRM),ISP(IRTBM),ISP(
     *IBTRMC),NBLCKB,NBLACK,ISP(C),ISP(IC),ISP(CP),IJA,ISP(
     *IJAB),ISP(ID2I),ISP(IPVT),NZRS,ISP(IJRS),A,RHS,RSP(D2I),
     *RSP(RSRHS),RSP(RS),RSP(ROW),RSP(C1DI))
      IF(IBLK.EQ.0)THEN
      CALLPCRSAD(NBLCKB,IBLKN,ISP(IBTRMC),ISP(IJRS))
      ENDIF
      ELSE
      NZRS=0
      ENDIF
      IMN=PRMSP(NZRB,ND2I)
      ISCR=MAXBLK
      MNEED=IMN+ISCR
      RETURN
      END
